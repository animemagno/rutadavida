<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venta de Ruta</title>
    <style>
        /* Estilos generales */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Pestañas */
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
        }

        .tab-button {
            padding: 12px 24px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .tab-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .tab-button.active {
            background-color: #2c3e50;
        }

        /* Contenido de las pestañas */
        .tab-content {
            display: none;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-top: 15px;
        }

        .tab-content.active {
            display: block;
        }

        /* Inputs y selects */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        input[type="text"], select {
            width: 100%;
            padding: 10px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }

        /* Botones */
        button {
            padding: 12px 24px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        /* Listas */
        .inventory-list, .sales-list, .sales-history, .expenses-history {
            list-style-type: none;
            padding: 0;
        }

        .inventory-list li, .sales-list li, .sales-history li, .expenses-history li {
            background: #fff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Tablas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #3498db;
            color: #fff;
        }

        tfoot td {
            font-weight: bold;
            background-color: #f8f9fa;
        }

        /* Botón de exportar */
        .export-button {
            margin-top: 20px;
            background-color: #27ae60;
        }

        .export-button:hover {
            background-color: #219653;
        }

        /* Fecha actual */
        .current-date {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: right;
            color: #2c3e50;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .tab-button {
                width: 100%;
                padding: 10px 15px;
                font-size: 14px;
            }

            h1 {
                font-size: 1.8rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            input[type="text"], select {
                font-size: 14px;
                padding: 8px;
            }

            button {
                padding: 10px 15px;
                font-size: 14px;
            }

            .inventory-list li, .sales-list li, .sales-history li, .expenses-history li {
                font-size: 12px;
                padding: 8px;
            }

            table, th, td {
                font-size: 12px;
                padding: 8px;
            }

            .fardos-section h3, .garrafones-section h3 {
                font-size: 1.2rem;
            }

            .fardos-section p, .garrafones-section p {
                font-size: 1rem;
            }
        }

        .sales-fields, .expenses-fields {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .sales-fields input, .expenses-fields input {
            flex: 1;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gastos-section {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .gastos-section h3 {
            font-size: 1.5rem;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 10px;
        }

        .gastos-section ul {
            list-style-type: none;
            padding: 0;
        }

        .gastos-section li {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .gastos-section .total-expenses {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .fardos-section {
            color: #e67e22;
            margin-bottom: 20px;
        }

        .fardos-section h3 {
            font-size: 1.5rem;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 10px;
        }

        .fardos-section p {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .garrafones-section {
            color: #27ae60;
            margin-bottom: 20px;
        }

        .garrafones-section h3 {
            font-size: 1.5rem;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 10px;
        }

        .garrafones-section p {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Venta de Ruta</h1>

        <!-- Pestañas -->
        <div class="tabs">
            <button class="tab-button" onclick="showTab('inventory')">Inventario</button>
            <button class="tab-button active" onclick="showTab('sales')">Ventas</button>
            <button class="tab-button" onclick="showTab('expenses')">Gastos</button>
            <button class="tab-button" onclick="showTab('summary')">Resumen</button>
        </div>

        <!-- Contenido de las pestañas -->
        <div id="inventory" class="tab-content">
            <h2>Inventario</h2>
            <div class="radio-group">
                <label>
                    <input type="radio" name="inventory-product" value="Fardos" checked> Fardos
                </label>
                <label>
                    <input type="radio" name="inventory-product" value="Garrafones"> Garrafones
                </label>
            </div>

            <label for="inventory-quantity">Cantidad:</label>
            <input type="text" id="inventory-quantity" placeholder="Ej: 100" oninput="validateNumber(this)" onkeypress="handleEnter(event, addToInventory)" inputmode="numeric">

            <button onclick="addToInventory()">Ingresar</button>

            <h2>Historial de Inventario</h2>
            <ul id="inventory-history" class="inventory-list"></ul>
        </div>

        <div id="sales" class="tab-content active">
            <h2>Venta</h2>
            <div class="radio-group">
                <label>
                    <input type="radio" name="sales-product" value="Fardos" checked> Fardos
                </label>
                <label>
                    <input type="radio" name="sales-product" value="Garrafones"> Garrafones
                </label>
                <label>
                    <input type="radio" name="sales-product" value="Cambio de fardo"> Cambio de fardo
                </label>
            </div>

            <div class="sales-fields">
                <div>
                    <label for="sales-quantity">Cantidad:</label>
                    <input type="text" id="sales-quantity" placeholder="Ej: 3" oninput="validateNumber(this)" onkeypress="handleEnter(event, () => document.getElementById('sales-price').focus())" inputmode="numeric">
                </div>
                <div>
                    <label for="sales-price">Precio:</label>
                    <input type="text" id="sales-price" placeholder="Ej: 2.70" oninput="validateNumber(this)" onkeypress="handleEnter(event, addSale)" inputmode="numeric">
                </div>
            </div>

            <button onclick="addSale()">Realizar Venta</button>

            <!-- Historial de Ventas -->
            <div class="sales-history">
                <h3>Historial de Ventas (Últimas 15)</h3>
                <ul id="sales-history-list" class="sales-history"></ul>
            </div>
        </div>

        <div id="expenses" class="tab-content">
            <h2>Registrar Gastos</h2>
            <div class="expenses-fields">
                <div>
                    <label for="expense-description">Descripción:</label>
                    <input type="text" id="expense-description" placeholder="Ej: Compra de materiales" onkeypress="handleEnter(event, () => document.getElementById('expense-amount').focus())">
                </div>
                <div>
                    <label for="expense-amount">Monto:</label>
                    <input type="text" id="expense-amount" placeholder="Ej: 50.00" oninput="validateNumber(this)" onkeypress="handleEnter(event, addExpense)" inputmode="numeric">
                </div>
            </div>

            <button onclick="addExpense()">Agregar Gasto</button>

            <!-- Historial de Gastos -->
            <div class="expenses-history">
                <h3>Historial de Gastos</h3>
                <ul id="expenses-history-list" class="expenses-history"></ul>
            </div>
        </div>

        <div id="summary" class="tab-content">
            <!-- Fecha actual -->
            <div class="current-date">
                <strong>Fecha:</strong> <span id="current-date"></span>
            </div>

            <h2>Resumen de Ventas y Gastos</h2>
            <table id="sales-table">
                <thead id="sales-table-head"></thead>
                <tbody id="sales-table-body"></tbody>
                <tfoot id="sales-table-foot"></tfoot>
            </table>
            <p class="total-sales"><strong>Total Vendido:</strong> $<span id="total-sales">0.00</span></p>

            <!-- Gastos -->
            <div id="gastos-container" class="gastos-section" style="display: none;">
                <h3>Gastos</h3>
                <ul id="expenses-summary-list" class="expenses-history"></ul>
                <p class="total-expenses">
                    <strong>Total de Gastos:</strong> $<span id="total-expenses">0.00</span>
                </p>
            </div>

            <!-- Resumen de Fardos -->
            <div id="fardos-container" class="fardos-section" style="display: none;">
                <h3>FARDOS: <span id="fardos-total">100</span></h3>
                <p style="display: none;">
                    <strong>Fardos Vendidos:</strong> <span id="fardos-vendidos">0</span>
                </p>
                <p style="display: none;">
                    <strong>Fardos Cambiados:</strong> <span id="fardos-cambiados">0</span>
                </p>
                <p style="display: none;">
                    <strong>Fardos Restantes:</strong> <span id="fardos-restantes">0</span>
                </p>
            </div>

            <!-- Resumen de Garrafones -->
            <div id="garrafones-container" class="garrafones-section" style="display: none;">
                <h3>GARRAFONES: <span id="garrafones-total">10</span></h3>
                <p style="display: none;">
                    <strong>Garrafones Vendidos:</strong> <span id="garrafones-vendidos">0</span>
                </p>
                <p style="display: none;">
                    <strong>Garrafones Restantes:</strong> <span id="garrafones-restantes">0</span>
                </p>
            </div>

            <!-- Total de Ingresos -->
            <p class="net-balance">
                <strong>Total de Ingresos:</strong> $<span id="net-balance">0.00</span>
            </p>

            <!-- Botón para guardar como imagen -->
            <button class="export-button" onclick="saveAsImage()">Guardar</button>

            <!-- Botón para limpiar todos los datos -->
            <button onclick="clearAllData()">Limpiar Todos los Datos</button>
        </div>
    </div>

    <script>
        // Variables globales
        let inventory = []; // Almacena el inventario
        let sales = [];     // Almacena las ventas
        let expenses = [];  // Almacena los gastos
        let totalSales = 0; // Total de ventas
        let totalExpenses = 0; // Total de gastos
        let salesHistory = []; // Historial de ventas
        let inventoryHistory = []; // Historial de inventario
        let fardosVendidos = 0; // Cantidad de fardos vendidos
        let fardosCambiados = 0; // Cantidad de fardos cambiados
        let fardosRestantes = 0; // Cantidad de fardos restantes
        let garrafonesVendidos = 0; // Cantidad de garrafones vendidos

        // Función para mostrar pestañas
        function showTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Desactivar todos los botones de pestañas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar la pestaña seleccionada
            document.getElementById(tabName).classList.add('active');

            // Activar el botón de la pestaña seleccionada
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            // Actualizar la fecha si es la pestaña de Resumen
            if (tabName === 'summary') {
                updateCurrentDate();
                updateSalesSummary();
            }
        }

        // Función para validar que solo se ingresen números
        function validateNumber(input) {
            input.value = input.value.replace(/[^0-9.]/g, ''); // Solo permite números y puntos
        }

        // Función para manejar la tecla Enter
        function handleEnter(event, action) {
            if (event.key === "Enter") {
                event.preventDefault(); // Evitar el comportamiento por defecto
                action(); // Ejecutar la acción correspondiente
            }
        }

        // Función para agregar productos al inventario
        function addToInventory() {
            const product = document.querySelector('input[name="inventory-product"]:checked').value;
            const quantity = parseFloat(document.getElementById('inventory-quantity').value);

            // Validar campos
            if (!product || isNaN(quantity) || quantity <= 0) {
                alert("Por favor, ingresa una cantidad válida.");
                return;
            }

            // Verificar si el producto ya existe en el inventario
            const existingProduct = inventory.find(item => item.product === product);
            if (existingProduct) {
                existingProduct.quantity += quantity; // Sumar la cantidad si ya existe
            } else {
                inventory.push({ product, quantity }); // Agregar nuevo producto
            }

            // Agregar al historial de inventario
            inventoryHistory.push({ product, quantity, timestamp: new Date() });

            // Actualizar la lista de inventario
            updateInventoryList();

            // Limpiar el formulario
            document.getElementById('inventory-quantity').value = '';

            // Guardar en localStorage
            saveInventory();
        }

        // Función para actualizar la lista de inventario
        function updateInventoryList() {
            const inventoryHistoryList = document.getElementById('inventory-history');
            inventoryHistoryList.innerHTML = '';

            inventoryHistory.forEach(entry => {
                const li = document.createElement('li');
                const time = entry.timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                li.textContent = `${time} - ${entry.product}: ${entry.quantity} unidades`;
                inventoryHistoryList.appendChild(li);
            });

            // Actualizar el resumen de fardos y garrafones
            updateFardosSummary();
            updateGarrafonesSummary();
        }

        // Función para actualizar el resumen de fardos
        function updateFardosSummary() {
            const fardosContainer = document.getElementById('fardos-container');
            const fardosItem = inventory.find(item => item.product === "Fardos");

            if (fardosItem && fardosItem.quantity > 0) {
                // Mostrar la sección de Fardos
                fardosContainer.style.display = 'block';

                // Mostrar el total ingresado en el inventario (sin descontar ventas)
                const totalFardosIngresados = fardosItem.quantity + fardosVendidos + fardosCambiados;
                document.getElementById('fardos-total').textContent = totalFardosIngresados;

                // Mostrar los valores de ventas y cambios
                document.getElementById('fardos-vendidos').textContent = fardosVendidos;
                document.getElementById('fardos-cambiados').textContent = fardosCambiados;

                // Mostrar los fardos restantes (inventario actual)
                document.getElementById('fardos-restantes').textContent = fardosItem.quantity;

                // Ocultar subtítulos si no hay ventas, cambios o restantes
                document.getElementById('fardos-vendidos').parentElement.style.display = fardosVendidos > 0 ? 'block' : 'none';
                document.getElementById('fardos-cambiados').parentElement.style.display = fardosCambiados > 0 ? 'block' : 'none';
                document.getElementById('fardos-restantes').parentElement.style.display = (fardosVendidos > 0 || fardosCambiados > 0) ? 'block' : 'none';
            } else {
                // Ocultar la sección de Fardos si no hay inventario
                fardosContainer.style.display = 'none';
            }
        }

        // Función para actualizar el resumen de garrafones
        function updateGarrafonesSummary() {
            const garrafonesContainer = document.getElementById('garrafones-container');
            const garrafonesItem = inventory.find(item => item.product === "Garrafones");

            if (garrafonesItem && garrafonesItem.quantity > 0) {
                // Mostrar la sección de Garrafones
                garrafonesContainer.style.display = 'block';

                // Mostrar el total ingresado en el inventario (sin descontar ventas)
                const totalGarrafonesIngresados = garrafonesItem.quantity + garrafonesVendidos;
                document.getElementById('garrafones-total').textContent = totalGarrafonesIngresados;

                // Mostrar los valores de ventas
                document.getElementById('garrafones-vendidos').textContent = garrafonesVendidos;

                // Mostrar los garrafones restantes (inventario actual)
                document.getElementById('garrafones-restantes').textContent = garrafonesItem.quantity;

                // Ocultar subtítulos si no hay ventas o restantes
                document.getElementById('garrafones-vendidos').parentElement.style.display = garrafonesVendidos > 0 ? 'block' : 'none';
                document.getElementById('garrafones-restantes').parentElement.style.display = garrafonesVendidos > 0 ? 'block' : 'none';
            } else {
                // Ocultar la sección de Garrafones si no hay inventario
                garrafonesContainer.style.display = 'none';
            }
        }

        // Función para realizar una venta
        function addSale() {
            const product = document.querySelector('input[name="sales-product"]:checked').value;
            const quantityInput = document.getElementById('sales-quantity');
            const priceInput = document.getElementById('sales-price');
            
            const quantity = parseFloat(quantityInput.value);
            let total = parseFloat(priceInput.value);

            // Validar campos obligatorios
            if (!product || isNaN(quantity) || quantity <= 0) {
                alert("Por favor, completa todos los campos correctamente.");
                return;
            }

            // Si el producto es "Fardos", validar el precio
            if (product === "Fardos" && (isNaN(total) || total <= 0)) {
                alert("Por favor, ingresa un precio válido para los fardos.");
                return;
            }

            // Validar existencia de Garrafones
            if (product === "Garrafones") {
                const garrafonesItem = inventory.find(item => item.product === "Garrafones");
                if (!garrafonesItem || garrafonesItem.quantity < quantity) {
                    alert("No hay suficientes Garrafones en el inventario.");
                    return;
                }
                garrafonesItem.quantity -= quantity; // Reducir inventario
            }

            // Lógica para "Cambio de fardo"
            if (product === "Cambio de fardo") {
                total = 0; // No hay precio en el cambio de fardo
                const fardosItem = inventory.find(item => item.product === "Fardos");
                if (!fardosItem || fardosItem.quantity < quantity) {
                    alert("No hay suficientes fardos en el inventario para realizar el cambio.");
                    return;
                }
                fardosItem.quantity -= quantity;
                fardosCambiados += quantity;
            } 
            // Lógica para Garrafones
            else if (product === "Garrafones") {
                total = quantity * 2; // Precio fijo de $2 por garrafón
                priceInput.value = total.toFixed(2);
                garrafonesVendidos += quantity; // Actualizar la cantidad de garrafones vendidos
            }
            // Lógica para Fardos normales
            else {
                const inventoryItem = inventory.find(item => item.product === product);
                if (!inventoryItem || inventoryItem.quantity < quantity) {
                    alert("No hay suficiente stock para realizar la venta.");
                    return;
                }
                inventoryItem.quantity -= quantity;
                fardosVendidos += quantity;
            }

            // Registrar la venta
            const sale = { 
                product, 
                quantity, 
                total: product === "Garrafones" ? total : parseFloat(total.toFixed(2)), 
                timestamp: new Date() 
            };
            
            sales.push(sale);
            salesHistory.unshift(sale);
            
            // Mantener máximo 15 ventas en el historial
            if (salesHistory.length > 15) salesHistory.pop();

            // Actualizar totales y UI
            totalSales += sale.total;
            updateInventoryList();
            updateSalesSummary();
            updateSalesHistory();

            // Limpiar campos y enfocar
            quantityInput.value = '';
            priceInput.value = '';
            quantityInput.focus(); // Volver al campo de cantidad

            // Guardar en localStorage
            saveSales();
            saveCounters();
        }

        // Función para agregar un gasto
        function addExpense() {
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);

            // Validar campos
            if (!description || isNaN(amount) || amount <= 0) {
                alert("Por favor, completa todos los campos correctamente.");
                return;
            }

            // Agregar el gasto al array de gastos
            expenses.push({ description, amount, timestamp: new Date() });

            // Actualizar el total de gastos
            totalExpenses += amount;

            // Actualizar el resumen
            updateSalesSummary();

            // Actualizar el historial de gastos
            updateExpensesHistory();

            // Limpiar el formulario de gastos
            document.getElementById('expense-description').value = '';
            document.getElementById('expense-amount').value = '';

            // Guardar en localStorage
            saveExpenses();
        }

        // Función para actualizar el historial de gastos
        function updateExpensesHistory() {
            const expensesHistoryList = document.getElementById('expenses-history-list');
            expensesHistoryList.innerHTML = '';

            expenses.forEach(expense => {
                const li = document.createElement('li');
                const time = expense.timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                li.textContent = `${time} - ${expense.description}: $${expense.amount.toFixed(2)}`;
                expensesHistoryList.appendChild(li);
            });
        }

        // Función para actualizar el resumen de ventas y gastos
        function updateSalesSummary() {
            // Reiniciar totales
            let total1 = 0, total095 = 0, total090 = 0, total085 = 0, total083 = 0;
            let fardos1 = 0, fardos095 = 0, fardos090 = 0, fardos085 = 0, fardos083 = 0;
            let garrafonesTotal = 0;

            // Calcular totales por precio unitario
            sales.forEach(sale => {
                if (sale.product === "Fardos") {
                    const unitPrice = (sale.total / sale.quantity).toFixed(2);
                    switch (unitPrice) {
                        case "1.00":
                            total1 += sale.total;
                            fardos1 += sale.quantity;
                            break;
                        case "0.95":
                            total095 += sale.total;
                            fardos095 += sale.quantity;
                            break;
                        case "0.90":
                            total090 += sale.total;
                            fardos090 += sale.quantity;
                            break;
                        case "0.85":
                            total085 += sale.total;
                            fardos085 += sale.quantity;
                            break;
                        case "0.83":
                            total083 += sale.total;
                            fardos083 += sale.quantity;
                            break;
                    }
                } else if (sale.product === "Garrafones") {
                    garrafonesTotal += sale.total;
                }
            });

            // Actualizar la tabla de resumen
            const tableHead = document.getElementById('sales-table-head');
            const tableBody = document.getElementById('sales-table-body');
            const tableFoot = document.getElementById('sales-table-foot');

            // Limpiar la tabla
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            tableFoot.innerHTML = '';

            // Crear las columnas dinámicamente
            const columns = [
                { id: '1.00', label: '$1.00', total: total1, fardos: fardos1 },
                { id: '0.95', label: '$0.95', total: total095, fardos: fardos095 },
                { id: '0.90', label: '$0.90', total: total090, fardos: fardos090 },
                { id: '0.85', label: '$0.85', total: total085, fardos: fardos085 },
                { id: '0.83', label: '6 x $5', total: total083, fardos: fardos083 },
                { id: 'garrafones', label: 'Garrafones', total: garrafonesTotal, fardos: garrafonesVendidos }
            ];

            // Filtrar columnas que tienen ventas
            const activeColumns = columns.filter(col => col.fardos > 0 || col.total > 0);

            // Crear el encabezado de la tabla
            const headRow = document.createElement('tr');
            activeColumns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col.label;
                headRow.appendChild(th);
            });
            tableHead.appendChild(headRow);

            // Crear el cuerpo de la tabla
            const bodyRow = document.createElement('tr');
            activeColumns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = col.fardos;
                bodyRow.appendChild(td);
            });
            tableBody.appendChild(bodyRow);

            // Crear el pie de la tabla
            const footRow = document.createElement('tr');
            activeColumns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = `$${col.total.toFixed(2)}`;
                footRow.appendChild(td);
            });
            tableFoot.appendChild(footRow);

            // Actualizar totales generales
            document.getElementById('total-sales').textContent = totalSales.toFixed(2);
            document.getElementById('total-expenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('net-balance').textContent = (totalSales - totalExpenses).toFixed(2);

            // Mostrar/ocultar sección de gastos
            const gastosContainer = document.getElementById('gastos-container');
            if (expenses.length > 0) {
                gastosContainer.style.display = 'block';
                
                // Mostrar lista de gastos
                const expensesSummaryList = document.getElementById('expenses-summary-list');
                expensesSummaryList.innerHTML = '';
                expenses.forEach(expense => {
                    const li = document.createElement('li');
                    li.textContent = `${expense.description}: $${expense.amount.toFixed(2)}`;
                    expensesSummaryList.appendChild(li);
                });
            } else {
                gastosContainer.style.display = 'none';
            }
        }

        // Función para actualizar el historial de ventas
        function updateSalesHistory() {
            const salesHistoryList = document.getElementById('sales-history-list');
            salesHistoryList.innerHTML = '';

            // Mostrar las últimas 15 ventas en el historial
            salesHistory.forEach((sale, index) => {
                const li = document.createElement('li');
                const time = sale.timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                li.textContent = `${time} - ${sale.quantity} x ${sale.product} - Total: $${sale.total.toFixed(2)}`;
                
                // Botón para modificar la venta
                const modifyButton = document.createElement('button');
                modifyButton.textContent = 'Modificar';
                modifyButton.className = 'modify-button';
                modifyButton.onclick = () => modifySale(index);
                li.appendChild(modifyButton);

                salesHistoryList.appendChild(li);
            });
        }

        // Función para modificar una venta
        function modifySale(index) {
            const sale = salesHistory[index];
            const product = sale.product;
            const quantity = sale.quantity;
            const total = sale.total;

            // Mostrar los valores de la venta en los campos de entrada
            document.querySelector(`input[name="sales-product"][value="${product}"]`).checked = true;
            document.getElementById('sales-quantity').value = quantity;
            document.getElementById('sales-price').value = total;

            // Eliminar la venta del historial y de las ventas totales
            salesHistory.splice(index, 1);
            sales.splice(sales.indexOf(sale), 1);
            totalSales -= total;

            // Actualizar el inventario si es necesario
            if (product === "Fardos") {
                fardosVendidos -= quantity;
                const inventoryItem = inventory.find(item => item.product === "Fardos");
                if (inventoryItem) {
                    inventoryItem.quantity += quantity;
                }
            } else if (product === "Garrafones") {
                garrafonesVendidos -= quantity;
            } else if (product === "Cambio de fardo") {
                fardosCambiados -= quantity;
                const inventoryItem = inventory.find(item => item.product === "Fardos");
                if (inventoryItem) {
                    inventoryItem.quantity += quantity;
                }
            }

            // Actualizar la UI
            updateInventoryList();
            updateSalesSummary();
            updateSalesHistory();

            // Guardar en localStorage
            saveSales();
            saveCounters();
        }

        // Función para guardar como imagen
        function saveAsImage() {
            const element = document.querySelector("#summary");

            // Obtener la fecha y hora actual
            const now = new Date();
            const formattedDate = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const formattedTime = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false });
            const fileName = `Venta de Ruta ${formattedDate} ${formattedTime}.jpg`;

            // Opciones para mejorar la resolución
            const scale = 2; // Aumentar la escala para mejorar la resolución
            html2canvas(element, {
                scale: scale, // Escala de la imagen
                logging: true, // Opcional: para depuración
                useCORS: true, // Permitir imágenes externas (si las hay)
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = fileName; // Usar el nombre del archivo con fecha y hora
                link.href = canvas.toDataURL('image/jpeg', 1.0); // Calidad máxima
                link.click();
            }).catch(error => {
                console.error("Error al generar la imagen:", error);
                alert("Hubo un error al intentar guardar la imagen. Por favor, inténtalo de nuevo.");
            });
        }

        // Función para actualizar la fecha actual
        function updateCurrentDate() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            document.getElementById('current-date').textContent = formattedDate;
        }

        // Función para guardar el inventario en localStorage
        function saveInventory() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('inventoryHistory', JSON.stringify(inventoryHistory));
        }

        // Función para guardar las ventas en localStorage
        function saveSales() {
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('salesHistory', JSON.stringify(salesHistory));
            localStorage.setItem('totalSales', JSON.stringify(totalSales));
        }

        // Función para guardar los gastos en localStorage
        function saveExpenses() {
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('totalExpenses', JSON.stringify(totalExpenses));
        }

        // Función para guardar los contadores de fardos y garrafones
        function saveCounters() {
            localStorage.setItem('fardosVendidos', JSON.stringify(fardosVendidos));
            localStorage.setItem('fardosCambiados', JSON.stringify(fardosCambiados));
            localStorage.setItem('garrafonesVendidos', JSON.stringify(garrafonesVendidos));
        }

        // Función para cargar datos desde localStorage
        function loadData() {
            inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            inventoryHistory = JSON.parse(localStorage.getItem('inventoryHistory')) || [];
            sales = JSON.parse(localStorage.getItem('sales')) || [];
            salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];
            totalSales = JSON.parse(localStorage.getItem('totalSales')) || 0;
            expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            totalExpenses = JSON.parse(localStorage.getItem('totalExpenses')) || 0;
            fardosVendidos = JSON.parse(localStorage.getItem('fardosVendidos')) || 0;
            fardosCambiados = JSON.parse(localStorage.getItem('fardosCambiados')) || 0;
            garrafonesVendidos = JSON.parse(localStorage.getItem('garrafonesVendidos')) || 0;

            updateInventoryList();
            updateSalesSummary();
            updateSalesHistory();
            updateExpensesHistory();
        }

        // Función para limpiar todos los datos
        function clearAllData() {
            localStorage.clear();
            inventory = [];
            inventoryHistory = [];
            sales = [];
            salesHistory = [];
            totalSales = 0;
            expenses = [];
            totalExpenses = 0;
            fardosVendidos = 0;
            fardosCambiados = 0;
            garrafonesVendidos = 0;

            updateInventoryList();
            updateSalesSummary();
            updateSalesHistory();
            updateExpensesHistory();

            alert("Todos los datos han sido eliminados.");
        }

        // Cargar datos al iniciar la página
        window.onload = function () {
            loadData();
            showTab('sales');
            updateCurrentDate();
        };
    </script>
    <!-- Incluir la librería html2canvas al final del body -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>
